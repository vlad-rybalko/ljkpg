(() => {
  const textEncoder = new TextEncoder();
  const textDecoder = new TextDecoder();
  const ITERATIONS = 100000;
  const KEY_LENGTH = 256;
  const IV_LENGTH = 12;
  const SALT_LENGTH = 16;

  function toBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.length; i += 1) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  function fromBase64(value) {
    const binary = atob(value);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i += 1) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes;
  }

  async function deriveKey(passphrase, salt) {
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      textEncoder.encode(passphrase),
      'PBKDF2',
      false,
      ['deriveKey'],
    );
    return crypto.subtle.deriveKey(
      {
        name: 'PBKDF2',
        salt,
        iterations: ITERATIONS,
        hash: 'SHA-256',
      },
      keyMaterial,
      { name: 'AES-GCM', length: KEY_LENGTH },
      false,
      ['encrypt', 'decrypt'],
    );
  }

  async function encrypt(plaintext, passphrase) {
    const salt = crypto.getRandomValues(new Uint8Array(SALT_LENGTH));
    const iv = crypto.getRandomValues(new Uint8Array(IV_LENGTH));
    const key = await deriveKey(passphrase, salt);
    const ciphertext = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      key,
      textEncoder.encode(plaintext),
    );

    const payload = {
      v: 1,
      s: toBase64(salt),
      i: toBase64(iv),
      d: toBase64(ciphertext),
    };

    return btoa(JSON.stringify(payload));
  }

  async function decrypt(ciphertext, passphrase) {
    const decoded = JSON.parse(atob(ciphertext));
    const salt = fromBase64(decoded.s);
    const iv = fromBase64(decoded.i);
    const data = fromBase64(decoded.d);
    const key = await deriveKey(passphrase, salt);
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv },
      key,
      data,
    );
    return textDecoder.decode(decrypted);
  }

  window.CryptoJS = {
    enc: { Utf8: 'utf8' },
    AES: { encrypt, decrypt },
  };
})();
